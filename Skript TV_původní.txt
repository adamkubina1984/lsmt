// === PRACOVNÍ PROSTOR PRO PINE v6 ===
// Cíl: iterovat beze chyb, s drobnými kroky a jasným changelogem.
// Jak spolupracovat:
// 1) Proveďte úpravy přímo zde, nebo napište, co změnit (řádek → změna).
// 2) V TV Editoru vložte kód a při chybě zkopírujte přesnou hlášku + číslo řádku sem.
// 3) Vždy budeme měnit jen malý blok, otestovat, a až pak další blok.
//
// Poznámky k Pine v6:
// - plotshape(text=...) musí mít const string (bez dynamiky) → používáme title, nebo label.new().
// - bool nikdy není na → nepoužívat var bool = na.
// - Nevolat line.delete(na) / label.delete(na) → hlídáme if not na(...).
// - Při práci s objekty preferovat aktualizaci set_* místo tvorby nových.
// - Proti dělení nulou: barRange = max(high-low, syminfo.mintick).
//
// Changelog:
// [v6-ws-001] Založen pracovní prostor, vložen skript s trailing SL a time-exit, doplněny drobné guardy.

//@version=6
indicator("Williams %R + ATR SL/TP + Více patternů (WS v6)", overlay=true, max_labels_count=500, max_lines_count=500, dynamic_requests=false)

// === Parametry ===
showSLTP           = input.bool(true,  "Zobrazit odhad SL/TP v grafu")
showPatternLabels  = input.bool(false, "Zobrazit názvy patternů")
investMode         = input.string("krátkodobý", "Režim strategie", options=["krátkodobý", "střednědobý"])

useWPR      = input.bool(true,  "Použít Williams %R")
useEMA      = input.bool(true,  "Použít EMA filtr")
useHTFEMA   = input.bool(true,  "Použít vyšší timeframe EMA (D/W)")
usePatterns = input.bool(true,  "Použít patterny svíček")
useSR       = input.bool(true,  "Použít Support/Resistance zóny (TODO)")

showFilters = input.bool(true, "Zobrazit stav filtrů v grafu")

autoAdjustRR = input.bool(true, "Automaticky přizpůsobit SL/TP podle průměrného RR (TODO)")

startHour   = input.int(8,  "Začátek obchodování (hodina)", minval=0, maxval=23)
endHour     = input.int(18, "Konec obchodování (hodina)",   minval=0, maxval=23)
isInSession = (hour >= startHour and hour < endHour)

// === Trail a časový výstup ===
enableTrailing   = input.bool(true,  "Zapnout trailing SL (ATR)")
trailMult        = input.float(1.5,  "ATR násobek pro trailing SL", step=0.1, minval=0.1)
maxBarsInTrade   = input.int(120,    "Max. počet svíček v obchodu (časový výstup)", minval=1)
enableTimeExit   = input.bool(true,  "Zapnout časový výstup")

// === Automatická úprava parametrů podle režimu ===
adjustedLengthWPR = investMode == "střednědobý" ? 50 : 15
adjustedATRLength = investMode == "střednědobý" ? 21 : 14
adjustedATRSL     = investMode == "střednědobý" ? 3.0 : 1.5
adjustedATRTP     = investMode == "střednědobý" ? 5.0 : 2.0
adjustedEMALength = investMode == "střednědobý" ? 100 : 50
htfTimeframe      = investMode == "střednědobý" ? "W" : "D"

// Uživatelské prahy WPR
overbought = input.int(-20, "Překoupený práh", minval=-100, maxval=0)
oversold   = input.int(-80, "Přeprodaný práh", minval=-100, maxval=0)
// Volitelné rozšíření validní zóny
wprUpper   = input.int(-30, "WPR horní hranice validní zóny", minval=-100, maxval=0)
wprLower   = input.int(-70, "WPR dolní hranice validní zóny", minval=-100, maxval=0)

// ATR/EMA parametry
atrLength  = adjustedATRLength
atrMultSL  = adjustedATRSL
atrMultTP  = adjustedATRTP
emaLength  = adjustedEMALength

// === Alternativa k EMA na HTF (hlc3) ===
altHTF = input.string("VWAP", "Alternativa k EMA", options=["EMA", "SMA", "VWAP"])
altHTFValue = request.security( syminfo.tickerid, htfTimeframe, altHTF == "EMA" ? ta.ema(hlc3, emaLength) : altHTF == "SMA" ? ta.sma(hlc3, emaLength) : ta.vwap(hlc3))

// === Williams %R ===
lengthWPR   = adjustedLengthWPR
highestHigh = ta.highest(high, lengthWPR)
lowestLow   = ta.lowest(low, lengthWPR)
wpr         = (highestHigh - close) / (highestHigh - lowestLow) * -100

plot(useWPR ? wpr : na, title="%R", color=color.blue, linewidth=1, display=display.data_window)
plotshape(wpr > overbought, title="Překoupený", location=location.abovebar, color=color.red,   style=shape.xcross, size=size.tiny)
plotshape(wpr < oversold,   title="Přeprodaný", location=location.belowbar, color=color.green, style=shape.circle, size=size.tiny)

// Striktnější validace
wprValid = not useWPR or (wpr < wprUpper and wpr > wprLower)

// === ATR ===
atr = ta.atr(atrLength)
atrThreshold     = ta.percentile_nearest_rank(atr, 100, 90)
isHighVolatility = atr > atrThreshold
volatilityValid  = not isHighVolatility

// === EMA filtr ===
ema = ta.ema(close, emaLength)
plot(useEMA ? ema : na, title="EMA", color=color.orange, linewidth=1)

isHTFUptrend   = close > altHTFValue
isHTFDowntrend = close < altHTFValue
plot(useHTFEMA ? altHTFValue : na, title="HTF trend (alt)", color=color.gray, linewidth=1)

// === Patterny ===
barRange  = math.max(high - low, syminfo.mintick)
bodySize  = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low

isBullPinBar = (bodySize / barRange < 0.4) and (lowerWick > 2 * bodySize) and (close > open)
isBearPinBar = (bodySize / barRange < 0.4) and (upperWick > 2 * bodySize) and (close < open)

isBullEngulf = close > open[1] and open < close[1] and close[1] < open[1]
isBearEngulf = close < open[1] and open > close[1] and close[1] > open[1]

isDoji        = bodySize / barRange < 0.1
isSpinningTop = bodySize / barRange < 0.3 and upperWick > 0.3 * barRange and lowerWick > 0.3 * barRange

isValidBull = not usePatterns or (isBullPinBar or isBullEngulf or (isDoji and close > open) or (isSpinningTop and close > open))
isValidBear = not usePatterns or (isBearPinBar or isBearEngulf or (isDoji and close < open) or (isSpinningTop and close < open))

// Vizualizace patternů – názvy pouze v title
plotshape(usePatterns and isBullPinBar,  title="Bull PinBar",  location=location.belowbar, color=color.new(color.lime,   0), style=shape.triangleup,   size=size.tiny)
plotshape(usePatterns and isBearPinBar,  title="Bear PinBar",  location=location.abovebar, color=color.new(color.red,    0), style=shape.triangledown, size=size.tiny)
plotshape(usePatterns and isBullEngulf,  title="Bull Engulf",  location=location.belowbar, color=color.new(color.green,  0), style=shape.triangleup,   size=size.tiny)
plotshape(usePatterns and isBearEngulf,  title="Bear Engulf",  location=location.abovebar, color=color.new(color.maroon, 0), style=shape.triangledown, size=size.tiny)
plotshape(usePatterns and isDoji,        title="Doji",         location=location.top,      color=color.new(color.gray,   0), style=shape.circle,       size=size.tiny)
plotshape(usePatterns and isSpinningTop, title="SpinningTop",  location=location.top,      color=color.new(color.silver, 0), style=shape.circle,       size=size.tiny)

// === Filtry ===
emaValidLong  = not useEMA or close > ema
emaValidShort = not useEMA or close < ema
htfValidLong  = not useHTFEMA or isHTFUptrend
htfValidShort = not useHTFEMA or isHTFDowntrend

// === Signály (vznik pouze na změnu, jen na potvrzené svíčce) ===
baseLong       = isValidBull  and wprValid and emaValidLong  and htfValidLong  and volatilityValid and isInSession
baseShort      = isValidBear  and wprValid and emaValidShort and htfValidShort and volatilityValid and isInSession
newLongSignal  = barstate.isconfirmed and baseLong  and not baseLong[1]
newShortSignal = barstate.isconfirmed and baseShort and not baseShort[1]

// === Aktivní obchod & SL/TP (persist) ===
var int   activeDir   = 0        // 1 = long, -1 = short, 0 = nic
var float activeSL    = na
var float activeTP    = na
var int   entryBar    = na
var float highestRun  = na      // nejvyšší cena od vstupu (pro long)
var float lowestRun   = na      // nejnižší cena od vstupu (pro short)

// vizuální objekty pro SL/TP – udržujeme jen jeden set
var line  slLine = na
var line  tpLine = na
var label slLbl  = na
var label tpLbl  = na

f_clear_objects(_slLine, _tpLine, _slLbl, _tpLbl) =>
    if not na(_slLine)
        line.delete(_slLine)
    if not na(_tpLine)
        line.delete(_tpLine)
    if not na(_slLbl)
        label.delete(_slLbl)
    if not na(_tpLbl)
        label.delete(_tpLbl)

f_draw_objects(_sl, _tp) =>
    _newSLLine = line.new(bar_index, _sl, bar_index + 1, _sl, extend=extend.none, color=color.red,   style=line.style_dashed, width=1)
    _newTPLine = line.new(bar_index, _tp, bar_index + 1, _tp, extend=extend.none, color=color.green, style=line.style_dashed, width=1)
    _newSLLbl  = label.new(bar_index + 1, _sl, yloc=yloc.price, text="SL: " + str.tostring(_sl, format.mintick), style=label.style_label_right, color=color.red,   textcolor=color.white, size=size.small)
    _newTPLbl  = label.new(bar_index + 1, _tp, yloc=yloc.price, text="TP: " + str.tostring(_tp, format.mintick), style=label.style_label_right, color=color.green, textcolor=color.white, size=size.small)
    [_newSLLine, _newTPLine, _newSLLbl, _newTPLbl]

f_update_objects(_sl, _tp, _slLine, _tpLine, _slLbl, _tpLbl) =>
    if not na(_slLine)
        line.set_xy1(_slLine, bar_index, _sl)
        line.set_xy2(_slLine, bar_index + 1, _sl)
    if not na(_tpLine)
        line.set_xy1(_tpLine, bar_index, _tp)
        line.set_xy2(_tpLine, bar_index + 1, _tp)
    if not na(_slLbl)
        label.set_x(_slLbl, bar_index + 1)
        label.set_y(_slLbl, _sl)
        label.set_text(_slLbl, "SL: " + str.tostring(_sl, format.mintick))
    if not na(_tpLbl)
        label.set_x(_tpLbl, bar_index + 1)
        label.set_y(_tpLbl, _tp)
        label.set_text(_tpLbl, "TP: " + str.tostring(_tp, format.mintick))

// === Vznik nového signálu ===
if newLongSignal
    activeDir  := 1
    activeSL   := close - atr * atrMultSL
    activeTP   := close + atr * atrMultTP
    entryBar   := bar_index
    highestRun := high
    lowestRun  := na
    f_clear_objects(slLine, tpLine, slLbl, tpLbl)
    slLine := na
    tpLine := na
    slLbl  := na
    tpLbl  := na
    [slLine, tpLine, slLbl, tpLbl] = f_draw_objects(activeSL, activeTP)

if newShortSignal
    activeDir  := -1
    activeSL   := close + atr * atrMultSL
    activeTP   := close - atr * atrMultTP
    entryBar   := bar_index
    highestRun := na
    lowestRun  := low
    f_clear_objects(slLine, tpLine, slLbl, tpLbl)
    slLine := na
    tpLine := na
    slLbl  := na
    tpLbl  := na
    [slLine, tpLine, slLbl, tpLbl] = f_draw_objects(activeSL, activeTP)

// === Trailing SL ===
if enableTrailing and activeDir != 0
    if activeDir == 1
        highestRun := na(highestRun) ? high : math.max(highestRun, high)
        newTrailSL = highestRun - atr * trailMult
        activeSL   := math.max(activeSL, newTrailSL)
    if activeDir == -1
        lowestRun  := na(lowestRun) ? low : math.min(lowestRun, low)
        newTrailSL = lowestRun + atr * trailMult
        activeSL   := math.min(activeSL, newTrailSL)

// === Alerty (vstupy) ===
alertcondition(newLongSignal,  title="Long signal",  message="LONG {{ticker}} @ {{close}}")
alertcondition(newShortSignal, title="Short signal", message="SHORT {{ticker}} @ {{close}}")

// === Zásah SL/TP ===
hitLongTP  = activeDir == 1  and high >= activeTP
hitLongSL  = activeDir == 1  and low  <= activeSL
hitShortTP = activeDir == -1 and low  <= activeTP
hitShortSL = activeDir == -1 and high >= activeSL

alertcondition(hitLongTP,  title="TP hit (Long)",  message="TP HIT LONG {{ticker}} @ {{close}}")
alertcondition(hitLongSL,  title="SL hit (Long)",  message="SL HIT LONG {{ticker}} @ {{close}}")
alertcondition(hitShortTP, title="TP hit (Short)", message="TP HIT SHORT {{ticker}} @ {{close}}")
alertcondition(hitShortSL, title="SL hit (Short)", message="SL HIT SHORT {{ticker}} @ {{close}}")

// === Časový výstup ===
timeExit = enableTimeExit and activeDir != 0 and not na(entryBar) and (bar_index - entryBar >= maxBarsInTrade)
alertcondition(timeExit, title="Time exit (bars limit reached)", message="TIME EXIT {{ticker}} @ {{close}}")


// === Reset po výstupu ===
exitNow = hitLongTP or hitLongSL or hitShortTP or hitShortSL or timeExit
if exitNow
    activeDir  := 0
    entryBar   := na
    highestRun := na
    lowestRun  := na
    f_clear_objects(slLine, tpLine, slLbl, tpLbl)
    slLine := na, tpLine := na, slLbl := na, tpLbl := na

// === Aktualizace vizuálů ===
if showSLTP and activeDir != 0
    f_update_objects(activeSL, activeTP, slLine, tpLine, slLbl, tpLbl)

// Datové výpisy (data window)
plot(activeDir == 1  ? activeSL : na,  title="Long SL",  display=display.data_window, color=color.red)
plot(activeDir == 1  ? activeTP : na,  title="Long TP",  display=display.data_window, color=color.green)
plot(activeDir == -1 ? activeSL : na,  title="Short SL", display=display.data_window, color=color.red)
plot(activeDir == -1 ? activeTP : na,  title="Short TP", display=display.data_window, color=color.green)

// Stav filtrů – vykreslit jen na posledním baru
if showFilters and barstate.islast
    var label filtersLbl = na
    if not na(filtersLbl)
        label.delete(filtersLbl)
    labelTextLong  = "LONG  | WPR " + (wprValid ? "✓" : "✗") + " | EMA " + (emaValidLong ? "✓" : "✗") + " | HTF " + (htfValidLong ? "✓" : "✗") + " | PAT " + (isValidBull ? "✓" : "✗") + " | Vol " + (volatilityValid ? "✓" : "✗")
    labelTextShort = "SHORT | WPR " + (wprValid ? "✓" : "✗") + " | EMA " + (emaValidShort ? "✓" : "✗") + " | HTF " + (htfValidShort ? "✓" : "✗") + " | PAT " + (isValidBear ? "✓" : "✗") + " | Vol " + (volatilityValid ? "✓" : "✗")
    filtersLbl := label.new(bar_index, high, text=labelTextLong + "\n" + labelTextShort, style=label.style_label_down, color=color.new(color.yellow, 85), textcolor=color.black, size=size.tiny)
